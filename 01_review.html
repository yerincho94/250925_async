<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DOM,BOM-Review(TODO APP)</title>
    <style>
      .memo {
        margin: 12px;
        border: 1px solid gray;
      }
      .done {
        background-color: silver;
      }
    </style>
  </head>
  <body>
    <form id="memoForm">
      <!-- name : form -> FormData를 이용해서 get하겠다.
         id : querySelector를 이용해서 value를 뽑아내겠다. -->
      <input
        type="text"
        name="memoTitle"
        placeholder="메모 제목을 입력하세요."
      />
      <br />
      <!-- input 확장 버전 -> 여러줄로 되어 있는 text input -->
      <textarea
        name="memoContent"
        placehoder="메모 내용을 입력하세요."
      ></textarea>
      <br />
      <button>추가</button>
      <!-- form 내부 배치를 br로 줄바꿈 할지, div로 하나하나 블록으로 나눌지, flex 바꿀지는 나의 선택 -->
    </form>
    <!-- 전체 삭제 -->
    <section><button id="clearBtn">전체 삭제</button></section>

    <!-- section#memoBox -> 하위 요소로 .memo div 요소들을 추가할 예정 (DOM을 여기 내부에다가 그려주겠다는 뜻) -->
    <section id="memoBox"></section>

    <script>
      //1. localStorage에 데이터를 넣고 그걸 불러오는 기능.
      const memoForm = document.querySelector("#memoForm");
      console.log("memoForm: ", memoForm);

      //addEventListener(이벤트명, 이벤트핸들러)
      memoForm.addEventListener("submit", (event) => {
        //event -> 있어야 기본적인 HTML 이벤트 작용이 가능하다!
        event.preventDefault();
        //memoForm === event.currentTarget
        const formData = new FormData(event.currentTarget);
        console.log(formData);
        //Iterator -> 유사 Array -> ...
        console.log(...formData.entries()); //rest연산자로 안에 내용 확인 가능

        const memo = {
          //삭제시 사용할 겹치지 않을 ID
          id: Date.now(), //현재 시간 기반의 숫자값
          title: formData.get("memoTitle"),
          content: formData.get("memoContent"),
          done: false,
        };
        console.log("memo: ", memo);

        //'List' -> 여러개의 데이터 묶음 (가변적인 길이)
        const rawMemoList = localStorage.getItem("memoList");
        const memoList = [];
        if (rawMemoList) {
          //text형태로 localStorage에 저장되어 있다면,
          console.log("저장된 메모 존재");
          //parse => 텍스트 형태로 되어 있는 것을, 메모리에서 사용할 수 있는 형태로 변경
          //배열 상태에 있는 데이터를 분해해서(...) 개별 요소로 하나씩 추가
          memoList.push(...JSON.parse(rawMemoList));
        }
        memoList.push(memo);
        localStorage.setItem("memoList", JSON.stringify(memoList));

        render(); //새롭게 데이터가 추가 되었을 때,
      });

      //2. function을 이용해서 로드를하여 localStorage에 있는 데이터로 그려주고, 데이터 추가, 변경 + 갱신
      //memo가 속할 상위 요소 -> append 시킬꺼임
      const memoBox = document.querySelector("#memoBox");

      function render() {
        const rawMemoList = localStorage.getItem("memoList");
        memoBox.innerHTML = ""; //초기화 (비우는걸 먼저 해야함)
        if (!rawMemoList) {
          return; //랜더링 할게 없다는 뜻
          //함수니까 여기서 끝내버리면 되고...
        }
        const memoList = JSON.parse(rawMemoList);
        for (const m of memoList) {
          const memo = document.createElement("div");
          memo.classList.add("memo");
          if (m.done) {
            memo.classList.add("done");
          }
          memo.innerHTML = `
                <h3>${m.title}</h3>
                <p>${m.content}</p>
                <p>${m.done ? "O" : "X"}</p>
            `;
          const removeBtn = document.createElement("button");
          //이것만 하면 데이터를 지운게 아니라, '화면에서만' 지워줌
          removeBtn.textContent = "삭제";
          removeBtn.addEventListener("click", () => {
            //임시 저장을 시키고
            const filtered = memoList.filter((v) => v.id !== m.id);
            // memoList.length = 0; //빈 배열로 만든 다음에,
            // memoList.push(...filtered); // 순서는 유지하면서 filter로 제거하고자하는 특정 요소만 제거한 채로 재추가
            console.log(filtered);
            localStorage.setItem("memoList", JSON.stringify(filtered));
            // memo.remove(); //화면에서만 제거 (개별로 화면에서 제거)
            render(); //전체적으로 리렌더링을 하거나,
          });

          //3.memo를 클릭하면 수행처리 (활성, 비활성)
          memo.addEventListener("dblclick", () => {
            const newMemo = {
              ...m,
              done: !m.done,
            };
            const mapped = memoList.map((v) => {
              if (v.id != m.id) {
                return v;
              } else {
                return newMemo;
              }
            });
            localStorage.setItem("memoList", JSON.stringify(mapped));
            // memo.classList.toggle("done");
            render(); // O/X 처리를 별도로 추가해주던가 아니면 리렌더링
          });

          //4. 클립보드 복사 기능
          const copyBtn = document.createElement("button");
          copyBtn.textContent = "복사";
          copyBtn.addEventListener("click", () => {
            navigator.clipboard.writeText(
              `제목: ${m.title}\n내용: ${m.content}\n완료여부: ${m.done}`
            );
          });
          memo.append(copyBtn);
          memo.append(removeBtn); //개별 각각 삭제 버튼 추가
          memoBox.append(memo);
        }
      }

      //전체 삭제(querySelector -> addEventListener 바로 사용 가능)
      document.querySelector("#clearBtn").addEventListener("click", () => {
        // localStorage.clear(); //현재 주소와 연관된 localStorage를 모두 지움
        localStorage.removeItem("memoList"); //특정한 키만 삭제
        render();
      });

      //전체 DOM 로딩이 끝났을때
      document.addEventListener("DOMContentLoaded", render);
    </script>
  </body>
</html>
